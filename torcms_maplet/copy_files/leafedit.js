"use strict";!function(factory,window){"function"==typeof define&&define.amd?define(["leaflet"],factory):"object"==typeof exports&&(module.exports=factory(require("leaflet"))),void 0!==window&&window.L&&factory(window.L)}(function(L){L.Editable=L.Evented.extend({statics:{FORWARD:1,BACKWARD:-1},options:{zIndex:1e3,polygonClass:L.Polygon,polylineClass:L.Polyline,markerClass:L.Marker,rectangleClass:L.Rectangle,circleClass:L.Circle,drawingCSSClass:"leaflet-editable-drawing",drawingCursor:"crosshair",editLayer:void 0,featuresLayer:void 0,polylineEditorClass:void 0,polygonEditorClass:void 0,markerEditorClass:void 0,rectangleEditorClass:void 0,circleEditorClass:void 0,lineGuideOptions:{},skipMiddleMarkers:!1},initialize:function(map,options){L.setOptions(this,options),this._lastZIndex=this.options.zIndex,this.map=map,this.editLayer=this.createEditLayer(),this.featuresLayer=this.createFeaturesLayer(),this.forwardLineGuide=this.createLineGuide(),this.backwardLineGuide=this.createLineGuide()},fireAndForward:function(type,e){e=e||{},e.editTools=this,this.fire(type,e),this.map.fire(type,e)},createLineGuide:function(){var options=L.extend({dashArray:"5,10",weight:1,interactive:!1},this.options.lineGuideOptions);return L.polyline([],options)},createVertexIcon:function(options){return L.Browser.touch?new L.Editable.TouchVertexIcon(options):new L.Editable.VertexIcon(options)},createEditLayer:function(){return this.options.editLayer||(new L.LayerGroup).addTo(this.map)},createFeaturesLayer:function(){return this.options.featuresLayer||(new L.LayerGroup).addTo(this.map)},moveForwardLineGuide:function(latlng){this.forwardLineGuide._latlngs.length&&(this.forwardLineGuide._latlngs[1]=latlng,this.forwardLineGuide._bounds.extend(latlng),this.forwardLineGuide.redraw())},moveBackwardLineGuide:function(latlng){this.backwardLineGuide._latlngs.length&&(this.backwardLineGuide._latlngs[1]=latlng,this.backwardLineGuide._bounds.extend(latlng),this.backwardLineGuide.redraw())},anchorForwardLineGuide:function(latlng){this.forwardLineGuide._latlngs[0]=latlng,this.forwardLineGuide._bounds.extend(latlng),this.forwardLineGuide.redraw()},anchorBackwardLineGuide:function(latlng){this.backwardLineGuide._latlngs[0]=latlng,this.backwardLineGuide._bounds.extend(latlng),this.backwardLineGuide.redraw()},attachForwardLineGuide:function(){this.editLayer.addLayer(this.forwardLineGuide)},attachBackwardLineGuide:function(){this.editLayer.addLayer(this.backwardLineGuide)},detachForwardLineGuide:function(){this.forwardLineGuide.setLatLngs([]),this.editLayer.removeLayer(this.forwardLineGuide)},detachBackwardLineGuide:function(){this.backwardLineGuide.setLatLngs([]),this.editLayer.removeLayer(this.backwardLineGuide)},blockEvents:function(){this._oldTargets||(this._oldTargets=this.map._targets,this.map._targets={})},unblockEvents:function(){this._oldTargets&&(this.map._targets=L.extend(this.map._targets,this._oldTargets),delete this._oldTargets)},registerForDrawing:function(editor){this._drawingEditor&&this.unregisterForDrawing(this._drawingEditor),this.map.on("mousemove touchmove",editor.onDrawingMouseMove,editor),this.blockEvents(),editor.reset(),this._drawingEditor=editor,this.map.on("mousedown",this.onMousedown,this),this.map.on("mouseup",this.onMouseup,this),L.DomUtil.addClass(this.map._container,this.options.drawingCSSClass),this.defaultMapCursor=this.map._container.style.cursor,this.map._container.style.cursor=this.options.drawingCursor},unregisterForDrawing:function(editor){this.unblockEvents(),L.DomUtil.removeClass(this.map._container,this.options.drawingCSSClass),this.map._container.style.cursor=this.defaultMapCursor,(editor=editor||this._drawingEditor)&&(this.map.off("mousemove touchmove",editor.onDrawingMouseMove,editor),this.map.off("mousedown",this.onMousedown,this),this.map.off("mouseup",this.onMouseup,this),editor===this._drawingEditor&&(delete this._drawingEditor,editor._drawing&&editor.cancelDrawing()))},onMousedown:function(e){this._mouseDown=e,this._drawingEditor.onDrawingMouseDown(e)},onMouseup:function(e){if(this._mouseDown){var editor=this._drawingEditor,mouseDown=this._mouseDown;if(this._mouseDown=null,editor.onDrawingMouseUp(e),this._drawingEditor!==editor)return;var origin=L.point(mouseDown.originalEvent.clientX,mouseDown.originalEvent.clientY),distance=L.point(e.originalEvent.clientX,e.originalEvent.clientY).distanceTo(origin);Math.abs(distance)<9*(window.devicePixelRatio||1)&&this._drawingEditor.onDrawingClick(e)}},drawing:function(){return this._drawingEditor&&this._drawingEditor.drawing()},stopDrawing:function(){this.unregisterForDrawing()},commitDrawing:function(e){this._drawingEditor&&this._drawingEditor.commitDrawing(e)},connectCreatedToMap:function(layer){return this.featuresLayer.addLayer(layer)},startPolyline:function(latlng,options){var line=this.createPolyline([],options);return line.enableEdit(this.map).newShape(latlng),line},startPolygon:function(latlng,options){var polygon=this.createPolygon([],options);return polygon.enableEdit(this.map).newShape(latlng),polygon},startMarker:function(latlng,options){latlng=latlng||this.map.getCenter().clone();var marker=this.createMarker(latlng,options);return marker.enableEdit(this.map).startDrawing(),marker},startRectangle:function(latlng,options){var corner=latlng||L.latLng([0,0]),bounds=new L.LatLngBounds(corner,corner),rectangle=this.createRectangle(bounds,options);return rectangle.enableEdit(this.map).startDrawing(),rectangle},startCircle:function(latlng,options){latlng=latlng||this.map.getCenter().clone();var circle=this.createCircle(latlng,options);return circle.enableEdit(this.map).startDrawing(),circle},startHole:function(editor,latlng){editor.newHole(latlng)},createLayer:function(klass,latlngs,options){options=L.Util.extend({editOptions:{editTools:this}},options);var layer=new klass(latlngs,options);return this.fireAndForward("editable:created",{layer:layer}),layer},createPolyline:function(latlngs,options){return this.createLayer(options&&options.polylineClass||this.options.polylineClass,latlngs,options)},createPolygon:function(latlngs,options){return this.createLayer(options&&options.polygonClass||this.options.polygonClass,latlngs,options)},createMarker:function(latlng,options){return this.createLayer(options&&options.markerClass||this.options.markerClass,latlng,options)},createRectangle:function(bounds,options){return this.createLayer(options&&options.rectangleClass||this.options.rectangleClass,bounds,options)},createCircle:function(latlng,options){return this.createLayer(options&&options.circleClass||this.options.circleClass,latlng,options)}}),L.extend(L.Editable,{makeCancellable:function(e){e.cancel=function(){e._cancelled=!0}}}),L.Map.mergeOptions({editToolsClass:L.Editable,editable:!1,editOptions:{}}),L.Map.addInitHook(function(){this.whenReady(function(){this.options.editable&&(this.editTools=new this.options.editToolsClass(this,this.options.editOptions))})}),L.Editable.VertexIcon=L.DivIcon.extend({options:{iconSize:new L.Point(8,8)}}),L.Editable.TouchVertexIcon=L.Editable.VertexIcon.extend({options:{iconSize:new L.Point(20,20)}}),L.Editable.VertexMarker=L.Marker.extend({options:{draggable:!0,className:"leaflet-div-icon leaflet-vertex-icon"},initialize:function(latlng,latlngs,editor,options){this.latlng=latlng,this.latlngs=latlngs,this.editor=editor,L.Marker.prototype.initialize.call(this,latlng,options),this.options.icon=this.editor.tools.createVertexIcon({className:this.options.className}),this.latlng.__vertex=this,this.editor.editLayer.addLayer(this),this.setZIndexOffset(editor.tools._lastZIndex+1)},onAdd:function(map){L.Marker.prototype.onAdd.call(this,map),this.on("drag",this.onDrag),this.on("dragstart",this.onDragStart),this.on("dragend",this.onDragEnd),this.on("mouseup",this.onMouseup),this.on("click",this.onClick),this.on("contextmenu",this.onContextMenu),this.on("mousedown touchstart",this.onMouseDown),this.addMiddleMarkers()},onRemove:function(map){this.middleMarker&&this.middleMarker.delete(),delete this.latlng.__vertex,this.off("drag",this.onDrag),this.off("dragstart",this.onDragStart),this.off("dragend",this.onDragEnd),this.off("mouseup",this.onMouseup),this.off("click",this.onClick),this.off("contextmenu",this.onContextMenu),this.off("mousedown touchstart",this.onMouseDown),L.Marker.prototype.onRemove.call(this,map)},onDrag:function(e){e.vertex=this,this.editor.onVertexMarkerDrag(e);var iconPos=L.DomUtil.getPosition(this._icon),latlng=this._map.layerPointToLatLng(iconPos);this.latlng.update(latlng),this._latlng=this.latlng,this.editor.refresh(),this.middleMarker&&this.middleMarker.updateLatLng();var next=this.getNext();next&&next.middleMarker&&next.middleMarker.updateLatLng()},onDragStart:function(e){e.vertex=this,this.editor.onVertexMarkerDragStart(e)},onDragEnd:function(e){e.vertex=this,this.editor.onVertexMarkerDragEnd(e)},onClick:function(e){e.vertex=this,this.editor.onVertexMarkerClick(e)},onMouseup:function(e){L.DomEvent.stop(e),e.vertex=this,this.editor.map.fire("mouseup",e)},onContextMenu:function(e){e.vertex=this,this.editor.onVertexMarkerContextMenu(e)},onMouseDown:function(e){e.vertex=this,this.editor.onVertexMarkerMouseDown(e)},delete:function(){var next=this.getNext();this.latlngs.splice(this.getIndex(),1),this.editor.editLayer.removeLayer(this),this.editor.onVertexDeleted({latlng:this.latlng,vertex:this}),this.latlngs.length||this.editor.deleteShape(this.latlngs),next&&next.resetMiddleMarker(),this.editor.refresh()},getIndex:function(){return this.latlngs.indexOf(this.latlng)},getLastIndex:function(){return this.latlngs.length-1},getPrevious:function(){if(!(this.latlngs.length<2)){var index=this.getIndex(),previousIndex=index-1;0===index&&this.editor.CLOSED&&(previousIndex=this.getLastIndex());var previous=this.latlngs[previousIndex];return previous?previous.__vertex:void 0}},getNext:function(){if(!(this.latlngs.length<2)){var index=this.getIndex(),nextIndex=index+1;index===this.getLastIndex()&&this.editor.CLOSED&&(nextIndex=0);var next=this.latlngs[nextIndex];return next?next.__vertex:void 0}},addMiddleMarker:function(previous){this.editor.hasMiddleMarkers()&&(previous=previous||this.getPrevious())&&!this.middleMarker&&(this.middleMarker=this.editor.addMiddleMarker(previous,this,this.latlngs,this.editor))},addMiddleMarkers:function(){if(this.editor.hasMiddleMarkers()){var previous=this.getPrevious();previous&&this.addMiddleMarker(previous);var next=this.getNext();next&&next.resetMiddleMarker()}},resetMiddleMarker:function(){this.middleMarker&&this.middleMarker.delete(),this.addMiddleMarker()},split:function(){this.editor.splitShape&&this.editor.splitShape(this.latlngs,this.getIndex())},continue:function(){if(this.editor.continueBackward){var index=this.getIndex();0===index?this.editor.continueBackward(this.latlngs):index===this.getLastIndex()&&this.editor.continueForward(this.latlngs)}}}),L.Editable.mergeOptions({vertexMarkerClass:L.Editable.VertexMarker}),L.Editable.MiddleMarker=L.Marker.extend({options:{opacity:.5,className:"leaflet-div-icon leaflet-middle-icon",draggable:!0},initialize:function(left,right,latlngs,editor,options){this.left=left,this.right=right,this.editor=editor,this.latlngs=latlngs,L.Marker.prototype.initialize.call(this,this.computeLatLng(),options),this._opacity=this.options.opacity,this.options.icon=this.editor.tools.createVertexIcon({className:this.options.className}),this.editor.editLayer.addLayer(this),this.setVisibility()},setVisibility:function(){var leftPoint=this._map.latLngToContainerPoint(this.left.latlng),rightPoint=this._map.latLngToContainerPoint(this.right.latlng),size=L.point(this.options.icon.options.iconSize);leftPoint.distanceTo(rightPoint)<3*size.x?this.hide():this.show()},show:function(){this.setOpacity(this._opacity)},hide:function(){this.setOpacity(0)},updateLatLng:function(){this.setLatLng(this.computeLatLng()),this.setVisibility()},computeLatLng:function(){var leftPoint=this.editor.map.latLngToContainerPoint(this.left.latlng),rightPoint=this.editor.map.latLngToContainerPoint(this.right.latlng),y=(leftPoint.y+rightPoint.y)/2,x=(leftPoint.x+rightPoint.x)/2;return this.editor.map.containerPointToLatLng([x,y])},onAdd:function(map){L.Marker.prototype.onAdd.call(this,map),L.DomEvent.on(this._icon,"mousedown touchstart",this.onMouseDown,this),map.on("zoomend",this.setVisibility,this)},onRemove:function(map){delete this.right.middleMarker,L.DomEvent.off(this._icon,"mousedown touchstart",this.onMouseDown,this),map.off("zoomend",this.setVisibility,this),L.Marker.prototype.onRemove.call(this,map)},onMouseDown:function(e){var iconPos=L.DomUtil.getPosition(this._icon);if(e={originalEvent:e,latlng:this.editor.map.layerPointToLatLng(iconPos)},0!==this.options.opacity&&(L.Editable.makeCancellable(e),this.editor.onMiddleMarkerMouseDown(e),!e._cancelled)){this.latlngs.splice(this.index(),0,e.latlng),this.editor.refresh();var icon=this._icon,marker=this.editor.addVertexMarker(e.latlng,this.latlngs),parent=marker._icon.parentNode;parent.removeChild(marker._icon),marker._icon=icon,parent.appendChild(marker._icon),marker._initIcon(),marker._initInteraction(),marker.setOpacity(1),L.Draggable._dragging=!1,marker.dragging._draggable._onDown(e.originalEvent),this.delete()}},delete:function(){this.editor.editLayer.removeLayer(this)},index:function(){return this.latlngs.indexOf(this.right.latlng)}}),L.Editable.mergeOptions({middleMarkerClass:L.Editable.MiddleMarker}),L.Editable.BaseEditor=L.Handler.extend({initialize:function(map,feature,options){L.setOptions(this,options),this.map=map,this.feature=feature,this.feature.editor=this,this.editLayer=new L.LayerGroup,this.tools=this.options.editTools||map.editTools},addHooks:function(){this.isConnected()?this.onFeatureAdd():this.feature.once("add",this.onFeatureAdd,this),this.onEnable(),this.feature.on(this._getEvents(),this)},removeHooks:function(){this.feature.off(this._getEvents(),this),this.feature.dragging&&this.feature.dragging.disable(),this.editLayer.clearLayers(),this.tools.editLayer.removeLayer(this.editLayer),this.onDisable(),this._drawing&&this.cancelDrawing()},drawing:function(){return!!this._drawing},reset:function(){},onFeatureAdd:function(){this.tools.editLayer.addLayer(this.editLayer),this.feature.dragging&&this.feature.dragging.enable()},hasMiddleMarkers:function(){return!this.options.skipMiddleMarkers&&!this.tools.options.skipMiddleMarkers},fireAndForward:function(type,e){e=e||{},e.layer=this.feature,this.feature.fire(type,e),this.tools.fireAndForward(type,e)},onEnable:function(){this.fireAndForward("editable:enable")},onDisable:function(){this.fireAndForward("editable:disable")},onEditing:function(){this.fireAndForward("editable:editing")},onStartDrawing:function(){this.fireAndForward("editable:drawing:start")},onEndDrawing:function(){this.fireAndForward("editable:drawing:end")},onCancelDrawing:function(){this.fireAndForward("editable:drawing:cancel")},onCommitDrawing:function(e){this.fireAndForward("editable:drawing:commit",e)},onDrawingMouseDown:function(e){this.fireAndForward("editable:drawing:mousedown",e)},onDrawingMouseUp:function(e){this.fireAndForward("editable:drawing:mouseup",e)},startDrawing:function(){this._drawing||(this._drawing=L.Editable.FORWARD),this.tools.registerForDrawing(this),this.onStartDrawing()},commitDrawing:function(e){this.onCommitDrawing(e),this.endDrawing()},cancelDrawing:function(){L.Draggable._dragging=!1,this.onCancelDrawing(),this.endDrawing()},endDrawing:function(){this._drawing=!1,this.tools.unregisterForDrawing(this),this.onEndDrawing()},onDrawingClick:function(e){this.drawing()&&(L.Editable.makeCancellable(e),this.fireAndForward("editable:drawing:click",e),e._cancelled||(this.isConnected()||this.connect(e),this.processDrawingClick(e)))},isConnected:function(){return this.map.hasLayer(this.feature)},connect:function(e){this.tools.connectCreatedToMap(this.feature),this.tools.editLayer.addLayer(this.editLayer)},onMove:function(e){this.fireAndForward("editable:drawing:move",e)},onDrawingMouseMove:function(e){this.onMove(e)},_getEvents:function(){return{dragstart:this.onDragStart,drag:this.onDrag,dragend:this.onDragEnd,remove:this.disable}},onDragStart:function(e){this.onEditing(),this.fireAndForward("editable:dragstart",e)},onDrag:function(e){this.onMove(e),this.fireAndForward("editable:drag",e)},onDragEnd:function(e){this.fireAndForward("editable:dragend",e)}}),L.Editable.MarkerEditor=L.Editable.BaseEditor.extend({onDrawingMouseMove:function(e){L.Editable.BaseEditor.prototype.onDrawingMouseMove.call(this,e),this._drawing&&this.feature.setLatLng(e.latlng)},processDrawingClick:function(e){this.fireAndForward("editable:drawing:clicked",e),this.commitDrawing(e)},connect:function(e){e&&(this.feature._latlng=e.latlng),L.Editable.BaseEditor.prototype.connect.call(this,e)}}),L.Editable.PathEditor=L.Editable.BaseEditor.extend({CLOSED:!1,MIN_VERTEX:2,addHooks:function(){return L.Editable.BaseEditor.prototype.addHooks.call(this),this.feature&&this.initVertexMarkers(),this},initVertexMarkers:function(latlngs){if(this.enabled())if(latlngs=latlngs||this.getLatLngs(),L.Polyline._flat(latlngs))this.addVertexMarkers(latlngs);else for(var i=0;i<latlngs.length;i++)this.initVertexMarkers(latlngs[i])},getLatLngs:function(){return this.feature.getLatLngs()},reset:function(){this.editLayer.clearLayers(),this.initVertexMarkers()},addVertexMarker:function(latlng,latlngs){return new this.tools.options.vertexMarkerClass(latlng,latlngs,this)},addVertexMarkers:function(latlngs){for(var i=0;i<latlngs.length;i++)this.addVertexMarker(latlngs[i],latlngs)},refreshVertexMarkers:function(latlngs){latlngs=latlngs||this.getDefaultLatLngs();for(var i=0;i<latlngs.length;i++)latlngs[i].__vertex.update()},addMiddleMarker:function(left,right,latlngs){return new this.tools.options.middleMarkerClass(left,right,latlngs,this)},onVertexMarkerClick:function(e){if(L.Editable.makeCancellable(e),this.fireAndForward("editable:vertex:click",e),!(e._cancelled||this.tools.drawing()&&this.tools._drawingEditor!==this)){var commit,index=e.vertex.getIndex();e.originalEvent.ctrlKey?this.onVertexMarkerCtrlClick(e):e.originalEvent.altKey?this.onVertexMarkerAltClick(e):e.originalEvent.shiftKey?this.onVertexMarkerShiftClick(e):e.originalEvent.metaKey?this.onVertexMarkerMetaKeyClick(e):index===e.vertex.getLastIndex()&&this._drawing===L.Editable.FORWARD?index>=this.MIN_VERTEX-1&&(commit=!0):0===index&&this._drawing===L.Editable.BACKWARD&&this._drawnLatLngs.length>=this.MIN_VERTEX?commit=!0:0===index&&this._drawing===L.Editable.FORWARD&&this._drawnLatLngs.length>=this.MIN_VERTEX&&this.CLOSED?commit=!0:this.onVertexRawMarkerClick(e),this.fireAndForward("editable:vertex:clicked",e),commit&&this.commitDrawing(e)}},onVertexRawMarkerClick:function(e){this.fireAndForward("editable:vertex:rawclick",e),e._cancelled||this.vertexCanBeDeleted(e.vertex)&&e.vertex.delete()},vertexCanBeDeleted:function(vertex){return vertex.latlngs.length>this.MIN_VERTEX},onVertexDeleted:function(e){this.fireAndForward("editable:vertex:deleted",e)},onVertexMarkerCtrlClick:function(e){this.fireAndForward("editable:vertex:ctrlclick",e)},onVertexMarkerShiftClick:function(e){this.fireAndForward("editable:vertex:shiftclick",e)},onVertexMarkerMetaKeyClick:function(e){this.fireAndForward("editable:vertex:metakeyclick",e)},onVertexMarkerAltClick:function(e){this.fireAndForward("editable:vertex:altclick",e)},onVertexMarkerContextMenu:function(e){this.fireAndForward("editable:vertex:contextmenu",e)},onVertexMarkerMouseDown:function(e){this.fireAndForward("editable:vertex:mousedown",e)},onMiddleMarkerMouseDown:function(e){this.fireAndForward("editable:middlemarker:mousedown",e)},onVertexMarkerDrag:function(e){this.onMove(e),this.feature._bounds&&this.extendBounds(e),this.fireAndForward("editable:vertex:drag",e)},onVertexMarkerDragStart:function(e){this.fireAndForward("editable:vertex:dragstart",e)},onVertexMarkerDragEnd:function(e){this.fireAndForward("editable:vertex:dragend",e)},setDrawnLatLngs:function(latlngs){this._drawnLatLngs=latlngs||this.getDefaultLatLngs()},startDrawing:function(){this._drawnLatLngs||this.setDrawnLatLngs(),L.Editable.BaseEditor.prototype.startDrawing.call(this)},startDrawingForward:function(){this.startDrawing()},endDrawing:function(){this.tools.detachForwardLineGuide(),this.tools.detachBackwardLineGuide(),this._drawnLatLngs&&this._drawnLatLngs.length<this.MIN_VERTEX&&this.deleteShape(this._drawnLatLngs),L.Editable.BaseEditor.prototype.endDrawing.call(this),delete this._drawnLatLngs},addLatLng:function(latlng){this._drawing===L.Editable.FORWARD?this._drawnLatLngs.push(latlng):this._drawnLatLngs.unshift(latlng),this.feature._bounds.extend(latlng),this.addVertexMarker(latlng,this._drawnLatLngs),this.refresh()},newPointForward:function(latlng){this.addLatLng(latlng),this.tools.attachForwardLineGuide(),this.tools.anchorForwardLineGuide(latlng)},newPointBackward:function(latlng){this.addLatLng(latlng),this.tools.anchorBackwardLineGuide(latlng)},push:function(latlng){if(!latlng)return console.error("L.Editable.PathEditor.push expect a vaild latlng as parameter");this._drawing===L.Editable.FORWARD?this.newPointForward(latlng):this.newPointBackward(latlng)},removeLatLng:function(latlng){latlng.__vertex.delete(),this.refresh()},pop:function(){if(!(this._drawnLatLngs.length<=1)){var latlng;return latlng=this._drawing===L.Editable.FORWARD?this._drawnLatLngs[this._drawnLatLngs.length-1]:this._drawnLatLngs[0],this.removeLatLng(latlng),this._drawing===L.Editable.FORWARD?this.tools.anchorForwardLineGuide(this._drawnLatLngs[this._drawnLatLngs.length-1]):this.tools.anchorForwardLineGuide(this._drawnLatLngs[0]),latlng}},processDrawingClick:function(e){e.vertex&&e.vertex.editor===this||(this._drawing===L.Editable.FORWARD?this.newPointForward(e.latlng):this.newPointBackward(e.latlng),this.fireAndForward("editable:drawing:clicked",e))},onDrawingMouseMove:function(e){L.Editable.BaseEditor.prototype.onDrawingMouseMove.call(this,e),this._drawing&&(this.tools.moveForwardLineGuide(e.latlng),this.tools.moveBackwardLineGuide(e.latlng))},refresh:function(){this.feature.redraw(),this.onEditing()},newShape:function(latlng){var shape=this.addNewEmptyShape();shape&&(this.setDrawnLatLngs(shape[0]||shape),this.startDrawingForward(),this.fireAndForward("editable:shape:new",{shape:shape}),latlng&&this.newPointForward(latlng))},deleteShape:function(shape,latlngs){var e={shape:shape};if(L.Editable.makeCancellable(e),this.fireAndForward("editable:shape:delete",e),!e._cancelled)return shape=this._deleteShape(shape,latlngs),this.ensureNotFlat&&this.ensureNotFlat(),this.feature.setLatLngs(this.getLatLngs()),this.refresh(),this.reset(),this.fireAndForward("editable:shape:deleted",{shape:shape}),shape},_deleteShape:function(shape,latlngs){if(latlngs=latlngs||this.getLatLngs(),latlngs.length){var self=this,spliceDelete=function(latlngs,shape){return latlngs.splice(latlngs.indexOf(shape),1),latlngs.length||self._deleteShape(latlngs),shape};if(latlngs===shape)return function(latlngs,shape){return latlngs.splice(0,Number.MAX_VALUE)}(latlngs);for(var i=0;i<latlngs.length;i++){if(latlngs[i]===shape)return spliceDelete(latlngs,shape);if(-1!==latlngs[i].indexOf(shape))return spliceDelete(latlngs[i],shape)}}},deleteShapeAt:function(latlng){var shape=this.feature.shapeAt(latlng);if(shape)return this.deleteShape(shape)},appendShape:function(shape){this.insertShape(shape)},prependShape:function(shape){this.insertShape(shape,0)},insertShape:function(shape,index){this.ensureMulti(),shape=this.formatShape(shape),void 0===index&&(index=this.feature._latlngs.length),this.feature._latlngs.splice(index,0,shape),this.feature.redraw(),this._enabled&&this.reset()},extendBounds:function(e){this.feature._bounds.extend(e.vertex.latlng)},onDragStart:function(e){this.editLayer.clearLayers(),L.Editable.BaseEditor.prototype.onDragStart.call(this,e)},onDragEnd:function(e){this.initVertexMarkers(),L.Editable.BaseEditor.prototype.onDragEnd.call(this,e)}}),L.Editable.PolylineEditor=L.Editable.PathEditor.extend({startDrawingBackward:function(){this._drawing=L.Editable.BACKWARD,this.startDrawing()},continueBackward:function(latlngs){this.drawing()||(latlngs=latlngs||this.getDefaultLatLngs(),this.setDrawnLatLngs(latlngs),latlngs.length>0&&(this.tools.attachBackwardLineGuide(),this.tools.anchorBackwardLineGuide(latlngs[0])),this.startDrawingBackward())},continueForward:function(latlngs){this.drawing()||(latlngs=latlngs||this.getDefaultLatLngs(),this.setDrawnLatLngs(latlngs),latlngs.length>0&&(this.tools.attachForwardLineGuide(),this.tools.anchorForwardLineGuide(latlngs[latlngs.length-1])),this.startDrawingForward())},getDefaultLatLngs:function(latlngs){return latlngs=latlngs||this.feature._latlngs,!latlngs.length||latlngs[0]instanceof L.LatLng?latlngs:this.getDefaultLatLngs(latlngs[0])},ensureMulti:function(){this.feature._latlngs.length&&L.Polyline._flat(this.feature._latlngs)&&(this.feature._latlngs=[this.feature._latlngs])},addNewEmptyShape:function(){if(this.feature._latlngs.length){var shape=[];return this.appendShape(shape),shape}return this.feature._latlngs},formatShape:function(shape){return L.Polyline._flat(shape)?shape:shape[0]?this.formatShape(shape[0]):void 0},splitShape:function(shape,index){if(index&&!(index>=shape.length-1)){this.ensureMulti();var shapeIndex=this.feature._latlngs.indexOf(shape);if(-1!==shapeIndex){var first=shape.slice(0,index+1),second=shape.slice(index);second[0]=L.latLng(second[0].lat,second[0].lng,second[0].alt),this.feature._latlngs.splice(shapeIndex,1,first,second),this.refresh(),this.reset()}}}}),L.Editable.PolygonEditor=L.Editable.PathEditor.extend({CLOSED:!0,MIN_VERTEX:3,newPointForward:function(latlng){L.Editable.PathEditor.prototype.newPointForward.call(this,latlng),this.tools.backwardLineGuide._latlngs.length||this.tools.anchorBackwardLineGuide(latlng),2===this._drawnLatLngs.length&&this.tools.attachBackwardLineGuide()},addNewEmptyHole:function(latlng){this.ensureNotFlat();var latlngs=this.feature.shapeAt(latlng);if(latlngs){var holes=[];return latlngs.push(holes),holes}},newHole:function(latlng){var holes=this.addNewEmptyHole(latlng);holes&&(this.setDrawnLatLngs(holes),this.startDrawingForward(),latlng&&this.newPointForward(latlng))},addNewEmptyShape:function(){if(this.feature._latlngs.length&&this.feature._latlngs[0].length){var shape=[];return this.appendShape(shape),shape}return this.feature._latlngs},ensureMulti:function(){this.feature._latlngs.length&&L.Polyline._flat(this.feature._latlngs[0])&&(this.feature._latlngs=[this.feature._latlngs])},ensureNotFlat:function(){this.feature._latlngs.length&&!L.Polyline._flat(this.feature._latlngs)||(this.feature._latlngs=[this.feature._latlngs])},vertexCanBeDeleted:function(vertex){var parent=this.feature.parentShape(vertex.latlngs);return L.Util.indexOf(parent,vertex.latlngs)>0||L.Editable.PathEditor.prototype.vertexCanBeDeleted.call(this,vertex)},getDefaultLatLngs:function(){return this.feature._latlngs.length||this.feature._latlngs.push([]),this.feature._latlngs[0]},formatShape:function(shape){return!L.Polyline._flat(shape)||shape[0]&&0===shape[0].length?shape:[shape]}}),L.Editable.RectangleEditor=L.Editable.PathEditor.extend({CLOSED:!0,MIN_VERTEX:4,options:{skipMiddleMarkers:!0},extendBounds:function(e){var index=e.vertex.getIndex(),next=e.vertex.getNext(),previous=e.vertex.getPrevious(),oppositeIndex=(index+2)%4,opposite=e.vertex.latlngs[oppositeIndex],bounds=new L.LatLngBounds(e.latlng,opposite);previous.latlng.update([e.latlng.lat,opposite.lng]),next.latlng.update([opposite.lat,e.latlng.lng]),this.updateBounds(bounds),this.refreshVertexMarkers()},onDrawingMouseDown:function(e){L.Editable.PathEditor.prototype.onDrawingMouseDown.call(this,e),this.connect();var latlngs=this.getDefaultLatLngs();3===latlngs.length&&latlngs.push(e.latlng);var bounds=new L.LatLngBounds(e.latlng,e.latlng);this.updateBounds(bounds),this.updateLatLngs(bounds),this.refresh(),this.reset(),this.map.dragging._draggable._onUp(e.originalEvent),latlngs[3].__vertex.dragging._draggable._onDown(e.originalEvent)},onDrawingMouseUp:function(e){this.commitDrawing(e),L.Editable.PathEditor.prototype.onDrawingMouseUp.call(this,e)},getDefaultLatLngs:function(latlngs){return latlngs||this.feature._latlngs[0]},updateBounds:function(bounds){this.feature._bounds=bounds},updateLatLngs:function(bounds){for(var latlngs=this.getDefaultLatLngs(),newLatlngs=this.feature._boundsToLatLngs(bounds),i=0;i<latlngs.length;i++)latlngs[i].update(newLatlngs[i])}}),L.Editable.CircleEditor=L.Editable.PathEditor.extend({MIN_VERTEX:2,options:{skipMiddleMarkers:!0},initialize:function(map,feature,options){L.Editable.PathEditor.prototype.initialize.call(this,map,feature,options),this._resizeLatLng=this.computeResizeLatLng()},computeResizeLatLng:function(){var delta=(this.feature._radius||this.feature._mRadius)*Math.cos(Math.PI/4),point=this.map.project(this.feature._latlng);return this.map.unproject([point.x+delta,point.y-delta])},updateResizeLatLng:function(){this._resizeLatLng.update(this.computeResizeLatLng()),this._resizeLatLng.__vertex.update()},getLatLngs:function(){return[this.feature._latlng,this._resizeLatLng]},getDefaultLatLngs:function(){return this.getLatLngs()},onVertexMarkerDrag:function(e){1===e.vertex.getIndex()?this.resize(e):this.updateResizeLatLng(e),L.Editable.PathEditor.prototype.onVertexMarkerDrag.call(this,e)},resize:function(e){var radius=this.feature._latlng.distanceTo(e.latlng);this.feature.setRadius(radius)},onDrawingMouseDown:function(e){L.Editable.PathEditor.prototype.onDrawingMouseDown.call(this,e),this._resizeLatLng.update(e.latlng),this.feature._latlng.update(e.latlng),this.connect(),this.map.dragging._draggable._onUp(e.originalEvent),this._resizeLatLng.__vertex.dragging._draggable._onDown(e.originalEvent)},onDrawingMouseUp:function(e){this.commitDrawing(e),L.Editable.PathEditor.prototype.onDrawingMouseUp.call(this,e)},onDrag:function(e){L.Editable.PathEditor.prototype.onDrag.call(this,e),this.feature.dragging.updateLatLng(this._resizeLatLng)}});var EditableMixin={createEditor:function(map){map=map||this._map;var tools=(this.options.editOptions||{}).editTools||map.editTools;if(!tools)throw Error("Unable to detect Editable instance.");return new(this.options.editorClass||this.getEditorClass(tools))(map,this,this.options.editOptions)},enableEdit:function(map){return this.editor||this.createEditor(map),this.editor.enable(),this.editor},editEnabled:function(){return this.editor&&this.editor.enabled()},disableEdit:function(){this.editor&&(this.editor.disable(),delete this.editor)},toggleEdit:function(){this.editEnabled()?this.disableEdit():this.enableEdit()},_onEditableAdd:function(){this.editor&&this.enableEdit()}},PolylineMixin={getEditorClass:function(tools){return tools&&tools.options.polylineEditorClass?tools.options.polylineEditorClass:L.Editable.PolylineEditor},shapeAt:function(latlng,latlngs){var shape=null;if(latlngs=latlngs||this._latlngs,!latlngs.length)return shape;if(L.Polyline._flat(latlngs)&&this.isInLatLngs(latlng,latlngs))shape=latlngs;else for(var i=0;i<latlngs.length;i++)if(this.isInLatLngs(latlng,latlngs[i]))return latlngs[i];return shape},isInLatLngs:function(l,latlngs){if(!latlngs)return!1;var i,k,len,p,part=[],w=this._clickTolerance();if(this._projectLatlngs(latlngs,part,this._pxBounds),part=part[0],p=this._map.latLngToLayerPoint(l),!this._pxBounds.contains(p))return!1;for(i=1,len=part.length,k=0;i<len;k=i++)if(L.LineUtil.pointToSegmentDistance(p,part[k],part[i])<=w)return!0;return!1}},PolygonMixin={getEditorClass:function(tools){return tools&&tools.options.polygonEditorClass?tools.options.polygonEditorClass:L.Editable.PolygonEditor},shapeAt:function(latlng,latlngs){var shape=null;if(latlngs=latlngs||this._latlngs,!latlngs.length)return shape
;if(L.Polyline._flat(latlngs)&&this.isInLatLngs(latlng,latlngs))shape=latlngs;else if(L.Polyline._flat(latlngs[0])&&this.isInLatLngs(latlng,latlngs[0]))shape=latlngs;else for(var i=0;i<latlngs.length;i++)if(this.isInLatLngs(latlng,latlngs[i][0]))return latlngs[i];return shape},isInLatLngs:function(l,latlngs){var l1,l2,j,k,len2,inside=!1;for(j=0,len2=latlngs.length,k=len2-1;j<len2;k=j++)l1=latlngs[j],l2=latlngs[k],l1.lat>l.lat!=l2.lat>l.lat&&l.lng<(l2.lng-l1.lng)*(l.lat-l1.lat)/(l2.lat-l1.lat)+l1.lng&&(inside=!inside);return inside},parentShape:function(shape,latlngs){if(latlngs=latlngs||this._latlngs){var idx=L.Util.indexOf(latlngs,shape);if(-1!==idx)return latlngs;for(var i=0;i<latlngs.length;i++)if(-1!==(idx=L.Util.indexOf(latlngs[i],shape)))return latlngs[i]}}},MarkerMixin={getEditorClass:function(tools){return tools&&tools.options.markerEditorClass?tools.options.markerEditorClass:L.Editable.MarkerEditor}},RectangleMixin={getEditorClass:function(tools){return tools&&tools.options.rectangleEditorClass?tools.options.rectangleEditorClass:L.Editable.RectangleEditor}},CircleMixin={getEditorClass:function(tools){return tools&&tools.options.circleEditorClass?tools.options.circleEditorClass:L.Editable.CircleEditor}},keepEditable=function(){this.on("add",this._onEditableAdd)};L.Polyline&&(L.Polyline.include(EditableMixin),L.Polyline.include(PolylineMixin),L.Polyline.addInitHook(keepEditable)),L.Polygon&&(L.Polygon.include(EditableMixin),L.Polygon.include(PolygonMixin)),L.Marker&&(L.Marker.include(EditableMixin),L.Marker.include(MarkerMixin),L.Marker.addInitHook(keepEditable)),L.Rectangle&&(L.Rectangle.include(EditableMixin),L.Rectangle.include(RectangleMixin)),L.Circle&&(L.Circle.include(EditableMixin),L.Circle.include(CircleMixin)),L.LatLng.prototype.update=function(latlng){latlng=L.latLng(latlng),this.lat=latlng.lat,this.lng=latlng.lng}},window);